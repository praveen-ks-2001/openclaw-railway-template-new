<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ¦ž OpenClaw â€” Setup Wizard</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style type="text/tailwindcss">
    @theme {
      --font-sans: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      --color-surface: #0d1117;
      --color-surface-raised: #161b22;
      --color-surface-overlay: #1c2129;
      --color-border: #30363d;
      --color-border-muted: #21262d;
      --color-accent: #e63946;
      --color-accent-hover: #d62836;
      --color-text-primary: #e6edf3;
      --color-text-secondary: #8b949e;
      --color-text-muted: #6e7681;
      --color-success: #3fb950;
      --color-warning: #d29922;
      --color-danger: #f85149;
    }
    [x-cloak] { display: none !important; }
    body { background: var(--color-surface); }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 3px; }
    .step-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; flex-shrink: 0; }
    .step-dot-active { background: var(--color-accent); color: #fff; }
    .step-dot-default { background: var(--color-surface-overlay); color: var(--color-text-muted); border: 1px solid var(--color-border); }
    .card { background: var(--color-surface-raised); border: 1px solid var(--color-border-muted); border-radius: 12px; padding: 24px; }
    .input-field { width: 100%; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; padding: 10px 14px; font-size: 14px; color: var(--color-text-primary); outline: none; transition: border-color 0.2s; }
    .input-field::placeholder { color: var(--color-text-muted); }
    .input-field:focus { border-color: var(--color-accent); }
    select.input-field { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b949e' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--color-accent); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--color-accent-hover); }
    .btn-secondary { background: var(--color-surface-overlay); color: var(--color-text-primary); border: 1px solid var(--color-border); }
    .btn-secondary:hover:not(:disabled) { background: var(--color-border-muted); }
    .btn-danger { background: transparent; color: var(--color-danger); border: 1px solid var(--color-danger); }
    .btn-danger:hover:not(:disabled) { background: var(--color-danger); color: #fff; }
    .btn-success { background: #238636; color: #fff; }
    .btn-success:hover:not(:disabled) { background: #2ea043; }
    .section-number { width: 32px; height: 32px; border-radius: 50%; background: var(--color-accent); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; flex-shrink: 0; }
    .log-box { background: var(--color-surface); border: 1px solid var(--color-border-muted); border-radius: 8px; padding: 16px; font-family: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, monospace; font-size: 12px; color: var(--color-text-secondary); white-space: pre-wrap; max-height: 240px; overflow-y: auto; }
  </style>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('setupApp', () => ({
        step: 1,
        totalSteps: 3,
        status: 'Loading...',
        configured: false,
        openclawVersion: '',
        authGroups: [],
        selectedGroup: '',
        authChoices: [],
        selectedAuth: '',
        authSecret: '',
        telegramToken: '',
        discordToken: '',
        slackBotToken: '',
        slackAppToken: '',
        model: '',
        log: '',
        loading: false,
        pairingChannel: '',
        pairingCode: '',
        showPairingModal: false,
        isReady: false,
        tuiEnabled: false,
        exporting: false,
        showExportInfo: false,
        showDevicesModal: false,
        devicesLoading: false,
        devices: [],
        devicesPending: [],
        devicesPaired: [],

        get currentGroup() {
          return this.authGroups.find(g => g.value === this.selectedGroup);
        },

        async init() {
          await this.refreshStatus();
        },

        async httpJson(url, opts = {}) {
          opts.credentials = 'same-origin';
          const res = await fetch(url, opts);
          if (!res.ok) {
            const t = await res.text();
            throw new Error('HTTP ' + res.status + ': ' + (t || res.statusText));
          }
          return res.json();
        },

        async refreshStatus() {
          this.status = 'Loading...';
          try {
            const j = await this.httpJson('/setup/api/status');
            this.configured = j.configured;
            this.openclawVersion = j.openclawVersion || '';
            this.tuiEnabled = j.tuiEnabled || false;
            this.status = j.configured ? 'Configured - open /openclaw' : 'Not configured - run setup below';
            this.authGroups = j.authGroups || [];
            if (this.authGroups.length > 0) {
              this.selectedGroup = this.authGroups[0].value;
              this.updateAuthChoices();
            }
            if (j.channelsAddHelp && j.channelsAddHelp.indexOf('telegram') === -1) {
              this.log += '\nNote: this openclaw build does not list telegram in `channels add --help`. Telegram auto-add will be skipped.\n';
            }
            this.isReady = true;
          } catch (e) {
            this.status = 'Error: ' + String(e);
            this.isReady = true;
          }
        },

        updateAuthChoices() {
          const group = this.currentGroup;
          this.authChoices = (group && group.options) ? group.options : [];
          if (this.authChoices.length > 0) {
            this.selectedAuth = this.authChoices[0].value;
          }
        },

        nextStep() {
          if (this.step < this.totalSteps) this.step++;
        },

        prevStep() {
          if (this.step > 1) this.step--;
        },

        async runSetup() {
          const payload = {
            authChoice: this.selectedAuth,
            authSecret: this.authSecret,
            model: this.model,
            telegramToken: this.telegramToken,
            discordToken: this.discordToken,
            slackBotToken: this.slackBotToken,
            slackAppToken: this.slackAppToken
          };

          this.log = 'Running...\n';
          this.loading = true;

          try {
            const res = await fetch('/setup/api/run', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const text = await res.text();
            let j;
            try { j = JSON.parse(text); } catch (_e) { j = { ok: false, output: text }; }
            this.log += (j.output || JSON.stringify(j, null, 2));
            await this.refreshStatus();
          } catch (e) {
            this.log += '\nError: ' + String(e) + '\n';
          } finally {
            this.loading = false;
          }
        },

        openPairingModal() {
          this.pairingChannel = '';
          this.pairingCode = '';
          this.showPairingModal = true;
        },

        async approvePairing() {
          const channel = this.pairingChannel.trim().toLowerCase();
          if (channel !== 'telegram' && channel !== 'discord') {
            alert('Channel must be "telegram" or "discord"');
            return;
          }
          const code = this.pairingCode.trim();
          if (!code) {
            alert('Please enter a pairing code');
            return;
          }
          this.showPairingModal = false;
          this.log += '\nApproving pairing for ' + channel + '...\n';

          try {
            const res = await fetch('/setup/api/pairing/approve', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ channel: channel, code: code })
            });
            const t = await res.text();
            let result;
            try { result = JSON.parse(t); } catch (_e) { result = { ok: false, output: t }; }
            if (result.ok) {
              const msg = result.output || 'Pairing approved successfully';
              this.log += 'âœ“ ' + msg + '\n';
              alert('âœ“ ' + msg.trim());
            } else {
              const msg = result.output || result.error || 'Unknown error';
              this.log += 'âœ— Failed: ' + msg + '\n';
              alert('âœ— Pairing failed: ' + msg.trim());
            }
          } catch (e) {
            this.log += 'âœ— Error: ' + String(e) + '\n';
            alert('âœ— Pairing failed: ' + String(e));
          }
        },

        async resetSetup() {
          if (!confirm('Reset setup? This deletes the config file so onboarding can run again.')) return;
          this.log = 'Resetting...\n';
          this.loading = true;

          try {
            const res = await fetch('/setup/api/reset', { method: 'POST', credentials: 'same-origin' });
            const t = await res.text();
            this.log += t + '\n';
            await this.refreshStatus();
          } catch (e) {
            this.log += 'Error: ' + String(e) + '\n';
          } finally {
            this.loading = false;
          }
        },

        async runDoctor() {
          this.log = 'Running doctor...\n';
          this.loading = true;

          try {
            const res = await fetch('/setup/api/doctor', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'content-type': 'application/json' }
            });
            const text = await res.text();
            let j;
            try { j = JSON.parse(text); } catch (_e) { j = { ok: false, output: text }; }
            this.log += (j.output || JSON.stringify(j, null, 2));
            if (j.ok) {
              this.log += '\nâœ“ Doctor completed successfully\n';
            } else {
              this.log += '\nâœ— Doctor found issues\n';
            }
          } catch (e) {
            this.log += 'Error: ' + String(e) + '\n';
          } finally {
            this.loading = false;
          }
        },

        async exportData() {
          this.exporting = true;
          this.log = 'Preparing export...\n';

          try {
            const res = await fetch('/setup/api/export', { credentials: 'same-origin' });
            if (!res.ok) {
              const text = await res.text();
              let j;
              try { j = JSON.parse(text); } catch (_e) { j = { error: text }; }
              this.log += 'âœ— Export failed: ' + (j.error || j.output || text) + '\n';
              return;
            }

            const disposition = res.headers.get('content-disposition') || '';
            const match = disposition.match(/filename="?([^"]+)"?/);
            const filename = match ? match[1] : 'openclaw-export.zip';

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);

            this.log += 'âœ“ Export downloaded: ' + filename + '\n';
            this.showExportInfo = true;
          } catch (e) {
            this.log += 'âœ— Export error: ' + String(e) + '\n';
          } finally {
            this.exporting = false;
          }
        },

        async openDevicesModal() {
          this.showDevicesModal = true;
          await this.loadDevices();
        },

        async loadDevices() {
          this.devicesLoading = true;
          try {
            const j = await this.httpJson('/setup/api/devices');
            const d = j.data;
            if (d) {
              if (Array.isArray(d)) {
                this.devicesPending = d.filter(x => x.status === 'pending');
                this.devicesPaired = d.filter(x => x.status !== 'pending');
              } else {
                this.devicesPending = d.pending || d.pendingRequests || d.requests || [];
                this.devicesPaired = d.devices || d.paired || d.approved || [];
              }
            } else {
              this.devicesPending = [];
              this.devicesPaired = [];
            }
            if (j.raw) {
              this.log += '[devices] ' + j.raw.trim() + '\n';
            }
          } catch (e) {
            this.log += 'âœ— Failed to load devices: ' + String(e) + '\n';
          } finally {
            this.devicesLoading = false;
          }
        },

        async approveDevice(requestId) {
          this.devicesLoading = true;
          try {
            const body = requestId ? { requestId } : {};
            const res = await fetch('/setup/api/devices/approve', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify(body)
            });
            const j = await res.json();
            if (j.ok) {
              this.log += 'âœ“ Device approved\n';
            } else {
              this.log += 'âœ— Approve failed: ' + (j.output || j.error || 'Unknown error') + '\n';
            }
            await this.loadDevices();
          } catch (e) {
            this.log += 'âœ— Error: ' + String(e) + '\n';
            this.devicesLoading = false;
          }
        },

        async rejectDevice(requestId) {
          this.devicesLoading = true;
          try {
            const res = await fetch('/setup/api/devices/reject', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ requestId })
            });
            const j = await res.json();
            if (j.ok) {
              this.log += 'âœ“ Device rejected\n';
            } else {
              this.log += 'âœ— Reject failed: ' + (j.output || j.error || 'Unknown error') + '\n';
            }
            await this.loadDevices();
          } catch (e) {
            this.log += 'âœ— Error: ' + String(e) + '\n';
            this.devicesLoading = false;
          }
        }
      }));
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
</head>

<body class="text-[var(--color-text-primary)] min-h-screen font-sans" x-data="setupApp()">
  <div class="flex min-h-screen">

    <!-- LEFT SIDEBAR -->
    <aside
      class="w-72 shrink-0 border-r border-[var(--color-border-muted)] bg-[var(--color-surface-raised)] sticky top-0 h-screen overflow-y-auto hidden lg:flex flex-col">
      <div class="p-6 pb-4 border-b border-[var(--color-border-muted)]">
        <img src="https://res.cloudinary.com/asset-cloudinary/image/upload/v1769907898/openclaw-logo-text_w3qcgl.avif"
          alt="OpenClaw" class="h-8">
        <p class="text-xs text-[var(--color-text-muted)] mt-2">Setup Wizard</p>
      </div>
      <nav class="flex-1 p-6">
        <p class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-5">How to Setup
        </p>
        <ol class="space-y-5">
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-active">1</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-primary)]">Wait for engine</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Takes ~15-20s to initialize</p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-default">2</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-secondary)]">Select provider</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Choose AI provider & paste API key</p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-default">3</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-secondary)]">Add channels</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Connect Telegram, Discord, or Slack</p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-default">4</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-secondary)]">Run setup</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Takes ~30s to configure</p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-default">5</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-secondary)]">Approve pairing</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Only if you added channel tokens</p>
            </div>
          </li>
          <li class="flex items-start gap-3">
            <span class="step-dot step-dot-default">6</span>
            <div>
              <p class="text-sm font-medium text-[var(--color-text-secondary)]">Open UI</p>
              <p class="text-xs text-[var(--color-text-muted)] mt-0.5">Start using OpenClaw!</p>
            </div>
          </li>
        </ol>
      </nav>
      <div class="p-6 pt-0">
        <div class="text-xs text-[var(--color-text-muted)]">
          <span x-show="openclawVersion" x-text="'v' + openclawVersion"></span>
        </div>
      </div>
    </aside>

    <!-- RIGHT MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto">
      <!-- Top bar -->
      <header
        class="sticky top-0 z-10 bg-[var(--color-surface)]/80 backdrop-blur-md border-b border-[var(--color-border-muted)] px-6 py-3 flex items-center justify-between">
        <div class="lg:hidden">
          <img src="https://res.cloudinary.com/asset-cloudinary/image/upload/v1769907898/openclaw-logo-text_w3qcgl.avif"
            alt="OpenClaw" class="h-7">
        </div>
        <div class="hidden lg:block"></div>
        <div class="flex items-center gap-3">
          <span x-show="configured"
            class="inline-flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-full bg-[#238636]/15 text-[var(--color-success)] border border-[#238636]/30">
            <span class="w-1.5 h-1.5 rounded-full bg-[var(--color-success)]"></span> Configured
          </span>
          <span x-show="!configured && isReady"
            class="inline-flex items-center gap-1.5 text-xs font-medium px-3 py-1.5 rounded-full bg-[var(--color-warning)]/15 text-[var(--color-warning)] border border-[var(--color-warning)]/30">
            <span class="w-1.5 h-1.5 rounded-full bg-[var(--color-warning)]"></span> Not configured
          </span>
          <a x-show="tuiEnabled && configured" href="/tui" target="_blank"
            class="btn btn-secondary text-xs !py-1.5 !px-3">Terminal</a>
        </div>
      </header>

      <div class="max-w-2xl mx-auto px-6 py-8 space-y-8">

        <!-- ===================== PRE-SETUP VIEW ===================== -->
        <template x-if="isReady && !configured">
          <div class="space-y-8">

            <!-- SECTION 1: Model / Auth Provider -->
            <section class="card">
              <div class="flex items-center gap-3 mb-6">
                <span class="section-number">1</span>
                <h2 class="text-lg font-semibold">Model / Auth Provider</h2>
              </div>
              <div class="space-y-5">
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Provider
                    Group</label>
                  <select x-model="selectedGroup" @change="updateAuthChoices()" class="input-field">
                    <template x-for="g in authGroups" :key="g.value">
                      <option :value="g.value" x-text="g.label + (g.hint ? ' â€” ' + g.hint : '')"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Auth
                    Method</label>
                  <select x-model="selectedAuth" class="input-field">
                    <template x-for="o in authChoices" :key="o.value">
                      <option :value="o.value" x-text="o.label + (o.hint ? ' â€” ' + o.hint : '')"></option>
                    </template>
                  </select>
                </div>
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">API
                    Key / Token</label>
                  <input x-model="authSecret" type="password" placeholder="Paste your API key or token"
                    class="input-field" />
                </div>
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Model</label>
                  <input x-model="model" type="text" placeholder="e.g. openai/gpt-4.1, anthropic/claude-sonnet-4"
                    class="input-field" />
                  <p class="text-xs text-[var(--color-text-muted)] mt-1.5">Format: provider/model-name</p>
                </div>
              </div>
            </section>

            <!-- SECTION 2: Channels -->
            <section class="card">
              <div class="flex items-center gap-3 mb-2">
                <span class="section-number">2</span>
                <h2 class="text-lg font-semibold">Channels</h2>
                <span
                  class="text-[10px] uppercase tracking-wide font-semibold text-[var(--color-text-muted)] bg-[var(--color-surface-overlay)] px-2 py-0.5 rounded">Optional</span>
              </div>
              <p class="text-sm text-[var(--color-text-secondary)] mb-6 ml-11">Connect messaging platforms. You can also
                add these later from the OpenClaw UI.</p>

              <div class="space-y-5">
                <!-- Telegram -->
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Telegram
                    Bot Token</label>
                  <input x-model="telegramToken" type="password" placeholder="Bot token from @BotFather"
                    class="input-field" />
                  <p class="text-xs text-[var(--color-text-muted)] mt-1.5">Get from <a href="https://t.me/BotFather"
                      target="_blank" class="text-[var(--color-accent)] hover:underline">@BotFather</a> â†’ <code
                      class="text-xs bg-[var(--color-surface-overlay)] px-1 py-0.5 rounded">/newbot</code></p>
                </div>
                <!-- Discord -->
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Discord
                    Bot Token</label>
                  <input x-model="discordToken" type="password" placeholder="Bot token from Developer Portal"
                    class="input-field" />
                  <p class="text-xs text-[var(--color-text-muted)] mt-1.5">Enable <strong
                      class="text-[var(--color-warning)]">MESSAGE CONTENT INTENT</strong> in Bot â†’ Privileged Gateway
                    Intents</p>
                </div>
                <!-- Slack -->
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Slack
                    Bot Token</label>
                  <input x-model="slackBotToken" type="password" placeholder="xoxb-..." class="input-field" />
                </div>
                <div>
                  <label
                    class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Slack
                    App Token</label>
                  <input x-model="slackAppToken" type="password" placeholder="xapp-..." class="input-field" />
                </div>
              </div>
            </section>

            <!-- SECTION 3: Review & Run -->
            <section class="card">
              <div class="flex items-center gap-3 mb-6">
                <span class="section-number">3</span>
                <h2 class="text-lg font-semibold">Review & Run</h2>
              </div>

              <!-- Summary Table -->
              <div class="bg-[var(--color-surface)] border border-[var(--color-border-muted)] rounded-lg p-4 mb-6">
                <p class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-3">Your
                  Configuration</p>
                <dl class="space-y-2.5 text-sm">
                  <div class="flex justify-between">
                    <dt class="text-[var(--color-text-secondary)]">Provider</dt>
                    <dd x-text="selectedGroup || 'â€”'" class="text-[var(--color-text-primary)] font-medium"></dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-[var(--color-text-secondary)]">Auth Method</dt>
                    <dd x-text="selectedAuth || 'â€”'" class="text-[var(--color-text-primary)] font-medium"></dd>
                  </div>
                  <div class="flex justify-between">
                    <dt class="text-[var(--color-text-secondary)]">Model</dt>
                    <dd x-text="model || 'Default'" class="text-[var(--color-text-primary)] font-medium"></dd>
                  </div>
                  <div class="flex justify-between items-center">
                    <dt class="text-[var(--color-text-secondary)]">Channels</dt>
                    <dd class="flex gap-1.5">
                      <span x-show="telegramToken"
                        class="text-xs bg-[#0088cc]/15 text-[#29b6f6] px-2 py-0.5 rounded">Telegram</span>
                      <span x-show="discordToken"
                        class="text-xs bg-[#5865F2]/15 text-[#7289da] px-2 py-0.5 rounded">Discord</span>
                      <span x-show="slackBotToken && slackAppToken"
                        class="text-xs bg-[#4A154B]/15 text-[#e01e5a] px-2 py-0.5 rounded">Slack</span>
                      <span x-show="!telegramToken && !discordToken && !(slackBotToken && slackAppToken)"
                        class="text-xs text-[var(--color-text-muted)]">None</span>
                    </dd>
                  </div>
                </dl>
              </div>

              <!-- Action Buttons -->
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <button @click="runSetup()" :disabled="loading" class="btn btn-primary">
                  <span x-show="!loading">â–¶ Run Setup</span>
                  <span x-show="loading" class="flex items-center gap-2">
                    <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                    </svg>
                    Running...
                  </span>
                </button>
                <button @click="resetSetup()" :disabled="loading" class="btn btn-danger">Reset</button>
              </div>

              <div x-show="log" class="log-box" x-text="log"></div>
            </section>
          </div>
        </template>

        <!-- ===================== POST-SETUP VIEW ===================== -->
        <template x-if="isReady && configured">
          <div class="space-y-6">

            <!-- Success + Open UI -->
            <section class="card">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-[#238636]/15 flex items-center justify-center">
                  <svg class="w-5 h-5 text-[var(--color-success)]" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold">Setup Complete</h2>
                  <p class="text-sm text-[var(--color-text-secondary)]">Your OpenClaw instance is configured and running
                  </p>
                </div>
              </div>
              <div class="flex gap-3 mt-4">
                <a href="/openclaw" target="_blank" class="btn btn-success">
                  Open OpenClaw UI
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              </div>
            </section>

            <!-- Devices & Channel Access -->
            <section class="card">
              <h3 class="text-base font-semibold mb-1">Devices & Access</h3>
              <p class="text-sm text-[var(--color-text-secondary)] mb-4">Manage devices and channel access</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button @click="openPairingModal()" :disabled="loading" class="btn btn-secondary w-full">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                  </svg>
                  Approve Channel Access
                </button>
                <button @click="openDevicesModal()" :disabled="loading" class="btn btn-secondary w-full">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  Manage Devices
                </button>
              </div>
            </section>

            <!-- Maintenance -->
            <section class="card">
              <h3 class="text-base font-semibold mb-1">Maintenance</h3>
              <p class="text-sm text-[var(--color-text-secondary)] mb-4">Health checks and data management</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <button @click="runDoctor()" :disabled="loading" class="btn btn-secondary w-full">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <span x-show="!loading">Run Doctor</span>
                  <span x-show="loading">Running...</span>
                </button>
                <button @click="exportData()" :disabled="loading || exporting" class="btn btn-secondary w-full">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  <span x-show="!exporting">Export Data</span>
                  <span x-show="exporting">Exporting...</span>
                </button>
              </div>
              <div x-show="log" class="log-box" x-text="log"></div>
            </section>

            <!-- Danger Zone -->
            <section class="card !border-[var(--color-danger)]/30">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="text-base font-semibold text-[var(--color-danger)]">Danger Zone</h3>
                  <p class="text-sm text-[var(--color-text-secondary)] mt-0.5">Deletes the config file so you can run
                    onboarding again from scratch.</p>
                </div>
                <button @click="resetSetup()" :disabled="loading" class="btn btn-danger shrink-0 ml-4">Reset
                  Setup</button>
              </div>
            </section>
          </div>
        </template>
      </div>
    </main>
  </div>

  <!-- ===================== MODALS ===================== -->

  <!-- Devices Modal -->
  <div x-show="showDevicesModal" x-cloak class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
    @click.self="showDevicesModal = false">
    <div class="card w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto !border-[var(--color-border)]">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Manage Devices</h3>
        <div class="flex items-center gap-2">
          <button @click="loadDevices()" :disabled="devicesLoading"
            class="p-2 rounded-lg hover:bg-[var(--color-surface-overlay)] text-[var(--color-text-secondary)] transition-colors">
            <svg class="w-4 h-4" :class="devicesLoading && 'animate-spin'" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
          </button>
          <button @click="showDevicesModal = false"
            class="p-2 rounded-lg hover:bg-[var(--color-surface-overlay)] text-[var(--color-text-secondary)] transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <p class="text-sm text-[var(--color-text-secondary)] mb-4">When a new browser connects to the Control UI, it
        requires a one-time pairing approval.</p>
      <button @click="approveDevice()" :disabled="devicesLoading" class="btn btn-primary w-full mb-4">
        <span x-show="!devicesLoading">Approve Latest Request</span>
        <span x-show="devicesLoading" class="flex items-center gap-2">
          <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
          </svg> Loading...
        </span>
      </button>
      <div class="space-y-4">
        <div>
          <h4 class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-2">Pending
            Requests</h4>
          <div x-show="devicesPending.length === 0 && !devicesLoading"
            class="text-sm text-[var(--color-text-muted)] bg-[var(--color-surface)] rounded-lg p-3 border border-[var(--color-border-muted)]">
            No pending requests</div>
          <div class="space-y-2">
            <template x-for="req in devicesPending" :key="req.requestId || req.id">
              <div
                class="flex items-center justify-between bg-[var(--color-surface)] border border-[var(--color-border-muted)] rounded-lg p-3">
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-medium truncate" x-text="req.requestId || req.id"></p>
                  <p x-show="req.createdAt" class="text-xs text-[var(--color-text-muted)]"
                    x-text="req.createdAt ? new Date(req.createdAt).toLocaleString() : ''"></p>
                </div>
                <div class="flex gap-2 ml-3 shrink-0">
                  <button @click="approveDevice(req.requestId || req.id)" :disabled="devicesLoading"
                    class="btn btn-success !py-1 !px-3 text-xs">Approve</button>
                  <button @click="rejectDevice(req.requestId || req.id)" :disabled="devicesLoading"
                    class="btn btn-danger !py-1 !px-3 text-xs">Reject</button>
                </div>
              </div>
            </template>
          </div>
        </div>
        <div>
          <h4 class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-2">Paired
            Devices</h4>
          <div x-show="devicesPaired.length === 0 && !devicesLoading"
            class="text-sm text-[var(--color-text-muted)] bg-[var(--color-surface)] rounded-lg p-3 border border-[var(--color-border-muted)]">
            No paired devices</div>
          <div class="space-y-2">
            <template x-for="dev in devicesPaired" :key="dev.deviceId || dev.id">
              <div
                class="flex items-center justify-between bg-[var(--color-surface)] border border-[var(--color-border-muted)] rounded-lg p-3">
                <div class="min-w-0 flex-1">
                  <p class="text-sm font-medium truncate" x-text="dev.deviceId || dev.id"></p>
                  <p class="text-xs text-[var(--color-text-muted)]">
                    <span x-show="dev.role" x-text="dev.role"
                      class="bg-[var(--color-surface-overlay)] px-1.5 py-0.5 rounded mr-1"></span>
                    <span x-show="dev.createdAt"
                      x-text="dev.createdAt ? new Date(dev.createdAt).toLocaleString() : ''"></span>
                  </p>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Info Modal -->
  <div x-show="showExportInfo" x-cloak class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
    @click.self="showExportInfo = false">
    <div class="card w-full max-w-md mx-4 !border-[var(--color-border)]">
      <h3 class="text-lg font-semibold mb-4">Unzip Instructions</h3>
      <p class="text-sm text-[var(--color-text-secondary)] mb-4">The exported ZIP is password-protected with your
        <strong>SETUP_PASSWORD</strong>.</p>
      <div class="space-y-4">
        <div>
          <p class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-2">macOS /
            Linux</p>
          <code
            class="block bg-[var(--color-surface)] border border-[var(--color-border-muted)] rounded-lg px-4 py-3 text-sm text-[var(--color-text-secondary)] font-mono">unzip -P YOUR_PASSWORD openclaw-export-*.zip</code>
        </div>
        <div>
          <p class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-2">Windows</p>
          <p class="text-sm text-[var(--color-text-secondary)]">Use <a href="https://www.7-zip.org/" target="_blank"
              class="text-[var(--color-accent)] hover:underline">7-Zip</a> to extract.</p>
        </div>
        <div>
          <p class="text-[10px] uppercase tracking-widest text-[var(--color-text-muted)] font-semibold mb-2">Using 7z
            CLI</p>
          <code
            class="block bg-[var(--color-surface)] border border-[var(--color-border-muted)] rounded-lg px-4 py-3 text-sm text-[var(--color-text-secondary)] font-mono">7z x -pYOUR_PASSWORD openclaw-export-*.zip</code>
        </div>
      </div>
      <button @click="showExportInfo = false" class="btn btn-secondary w-full mt-6">Close</button>
    </div>
  </div>

  <!-- Pairing Modal -->
  <div x-show="showPairingModal" x-cloak class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
    @click.self="showPairingModal = false">
    <div class="card w-full max-w-sm mx-4 !border-[var(--color-border)]">
      <h3 class="text-lg font-semibold mb-4">Approve Channel Access</h3>
      <div class="space-y-4">
        <div>
          <label
            class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Channel</label>
          <select x-model="pairingChannel" class="input-field">
            <option value="">Select channel...</option>
            <option value="telegram">Telegram</option>
            <option value="discord">Discord</option>
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-[var(--color-text-muted)] font-medium mb-2">Pairing
            Code</label>
          <input x-model="pairingCode" type="text" placeholder="e.g. 3EY4PUYS" class="input-field" />
        </div>
        <div class="flex gap-3 pt-2">
          <button @click="approvePairing()" class="btn btn-primary flex-1">Approve</button>
          <button @click="showPairingModal = false" class="btn btn-secondary flex-1">Cancel</button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>